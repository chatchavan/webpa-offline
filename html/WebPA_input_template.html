<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
      padding-bottom: 9em;
      color: #494e52;
      font-family: -apple-system, ".SFNSText-Regular", "San Francisco", "Roboto", "Segoe UI", "Helvetica Neue", "Lucida Grande", Arial, sans-serif;
      line-height:1.5
    }

    div#main {
      max-width: 925px;
      margin-left: auto;
      margin-right: auto;
      clear: both;
      margin-top: 2em;
      padding-left: 1em;
      padding-right: 1em;
    }

    select.rating {
      max-width: 10em;
    }

    textarea.comment {
      width: 100%;
      max-width: 30em;
    }

    table td {
      vertical-align: middle;
    }

    #jsonOutput {
      width: 300px;
      height: 200px;
      display: block;
    }

  </style>
</head>
<body>
  <div id="main">
    
    <h2>
      Team: <span id="teamId"></span>
    </h2>
    
    <div>
      <strong>Step 1 of 3:</strong> Rate the contribution of all members. 
    </div>

    <table id="studentTable">
    	<thead>
        <tr>
          <th>Name</th>
          <th>Rating</th>
          <th>(optional) Comment on this member</th>
        </tr>
      </thead>
    </table>

    <div>
      <hr/>
      <label for="me">Your name:</label>
      <select id="me" name="me"></select>
    </div>

    <div>

    </div>

    <div id="jsonDisplay">
      Preview of your rating data:
      <textarea id="jsonOutput" readonly></textarea>
      
      <strong>Step 2 of 3:</strong>  Download your rating data.
      <button id="downloadButton">Download</button>

      <div>
        <strong>Step 3 of 3:</strong> <span id="uploadInstruction">Upload this file to the URL as instructed.</span>
      </div>
    </div>

    
  </div>
</body>


<script>
let students = ["John Doe", "Jane Smith", "Sam Johnson", "Michael Brown"];
let teamId = 1;
let uploadInstruction = null;
let tableBody = document.querySelector("#studentTable");
let meSelect = document.querySelector("#me");
let data = {}; // Object to hold rating data
data['team'] = teamId;
data['rater'] = ''; 
data['ratings'] = {};

document.getElementById("teamId").innerText = teamId;

if (uploadInstruction !== null) {
  document.getElementById("uploadInstruction").innerText = uploadInstruction;
}

students.forEach((name, index) => {
  let row = document.createElement("tr");
  let nameCell = document.createElement("td");
  let commentCell = document.createElement("td");
  let ratingCell = document.createElement("td");

  nameCell.textContent = name;
  data.ratings[name] = {}; // Create a new object for the student's data

  let ratingSelect = document.createElement("select");
  ratingSelect.classList.add('rating');
  ratingSelect.addEventListener('change', (event) => {
    data.ratings[name].rating = event.target.value; // Update rating in data object
    updateUI(); // Call function to check if all fields are filled
  });
  // Adding an empty option at the beginning of each select element
  let blankOption = document.createElement("option");
  blankOption.value = '';
  blankOption.textContent = '--Select--';
  ratingSelect.appendChild(blankOption);
  for (const i of [1, 2, 3, 4, 5, "N/A"]) {
    var i_text = i + ": ";
    if (i == "N/A") {
      i_text = "(Not applicable, e.g., the member left the team)"
    }
    else if (i == 1) {
      i_text += "Made only a small contribution or contributed in a poor standard" 
    } else if (i == 3) {
      i_text += "Made an average contribution" 
    } else if (i == 5) {
      i_text += "Contributed to the most challenging aspects in a high standard"
    } else {
      i_text += "..."
    }

    let option = document.createElement("option");
    option.value = i;
    option.textContent = i_text;
    ratingSelect.appendChild(option);
  }
  ratingCell.appendChild(ratingSelect);

  let commentInput = document.createElement("textarea");
  commentInput.classList.add('comment');
  commentInput.addEventListener('input', (event) => {
    data.ratings[name].comment = event.target.value; // Update comment in data object
    updateUI();
  });
  commentCell.appendChild(commentInput);

  row.appendChild(nameCell);
  row.appendChild(ratingCell);
  row.appendChild(commentCell);

  tableBody.appendChild(row);
});

students.forEach((name, index) => {
  let option = document.createElement("option");
  option.value = name;
  option.textContent = name;
  meSelect.appendChild(option);
});


// Adding an empty option at the beginning of meSelect element
let blankOptionMe = document.createElement("option");
blankOptionMe.value = '';
blankOptionMe.textContent = '--Select--';
meSelect.insertBefore(blankOptionMe, meSelect.firstChild);

meSelect.addEventListener('change', (event) => {
  data['rater'] = event.target.value; // Update user property in data object
  updateUI();
});


// Function to check if all fields are filled correctly
function updateUI() {
  
  // check fields
  let isFilled = true;
  for (let student in data.ratings) {
    if (!data.ratings[student].rating) {
      isFilled = false;
      break;
    }
  }
  if (isFilled && data['rater']) {
    document.getElementById('jsonDisplay').hidden = false;
  } else {
    document.getElementById('jsonDisplay').hidden = true;
  }

  // update JSON output area
  let jsonData = JSON.stringify(data, null, 2); // Convert data object to JSON string
  document.querySelector("#jsonOutput").value = jsonData; // Update textarea value
}


function downloadTextAreaContent() {
    // Get the text area content
    var text = document.getElementById('jsonOutput').value;

    // Create a temporary anchor element
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', 'rating - ' + data['rater'] + '.json');

    // Add the element to the DOM
    document.body.appendChild(element);

    // Trigger a click on the anchor element
    element.click();

    // Remove the element from the DOM
    document.body.removeChild(element);
}

// Trigger the download when the button is clicked
document.getElementById('downloadButton').addEventListener('click', downloadTextAreaContent);


// initialize the visibility
updateUI()

</script>

</html>
